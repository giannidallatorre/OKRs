# python-OKR-statistics
This repository contains python clients to generate statistics about the total CPU/h and the number of users of the EGI Federated Infrastructure. 
Specifically, the statistics generated by these clients are:
- **Cloud CPU/h** consumed by the production VOs of EGI
- **HTC CPU/h** consumed by the production VOs of EGI
- Num. of **'active'**, **'total'** and **'actual' users** registered in the EGI Operations Portal. 

These statistics will be used by EGI to measure progress following the **Objectives and Key Results (OKRs)** goal-setting framework.

The statistics generated by these clients will be pushed in this Google <a href="https://docs.google.com/spreadsheets/d/1B1Sqf1UiN9pY_fGbWe5G1zKA2UzsekOVbLCtiiMFAXk/edit#">Worksheet</a> using the <a href="https://docs.gspread.org/en/v5.10.0/">gspread</a> APIs.

## Pre-requisites
* `Python 3.10.12+` installed on your local computer
* Install pip3: `apt-get install -y python3-pip`
* Install <a href="https://docs.gspread.org/en/v5.10.0/">gspread</a> APIs: `sudo pip3 install gspread`
* Install venv: `sudo apt install -y python3-venv`

## Creating a Google Service Account
In order to read from and write data to Google Sheets in Python, we will have to create a **Google Service Account**.

_"A service account is a special kind of account used by an application or a virtual machine (VM) instance, not a person. 
Applications use service accounts to make authorized API calls, authorized as either the service account itself or as Google Workspace 
or Cloud Identity users through domain-wide delegation"._

**Instructions** to create a Google Service Account are the following:
* Head over to <a href="https://console.developers.google.com/">Google developer console</a> and click on “**Create Project**”.
* Fill in the required fields and click on “**Create**”. You will be redirected to the project home page once the project is created.
* Click on “**Enable API and Services**”.
* Search for Google Drive API and click on “**Enable**”. Do the same for the Google Sheets API.
* Click on “**Create Credentials**”
* Select “**Google Drive API**” as the API and “Web server” (e.g. Node.js, Tomcat, etc.) as where you will be calling the API from. Follow the image below to fill in the other options.
* Name the service account, then grant it a “**Project**” role with “**Editor**” access and click on “**Continue**”.
* The credentials will be created and downloaded as a JSON file. If everything is successful, you will see a screen similar to the image below.
* Copy the JSON file to your code directory and rename it to `credentials.json`

## Configuring the environment

Use virtualenv to configure the working environment:

```
]$ virtualenv -p /usr/bin/python3.10 venv
created virtual environment CPython3.10.12.final.0-64 in 1748ms
  creator CPython3Posix(dest=/home/larocca/EGI-modules/APIs/OKR/2.0/venv, clear=False, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/larocca/.local/share/virtualenv)
    added seed packages: pip==22.0.2, setuptools==59.6.0, wheel==0.37.1
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator

]$ source venv/bin/activate
```

Install the libraries `gspread` with pip3:

```
]$ pip3 install gspread
[..]
```

## Install the credenatials of the Google Service Account

Install the JSON file downloaded when you created a Google Service Account nd rename it as `service_account.json`

```
]$ mkdir $PWD/.config
]$ cat .config/service_account.json 
{
  "type": "service_account",
  "project_id": "striped-rhino-395008",
  "private_key_id": "****************************",
  "private_key": "-----BEGIN PRIVATE KEY-----
  -----END PRIVATE KEY-----\n",
  "client_email": "python-google-sheet-service-ac@striped-rhino-395008.iam.gserviceaccount.com",
  "client_id": "***************",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/python-google-sheet-service-ac%40striped-rhino-395008.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com"
}
```

## Avaliable clients

This GitHub repository includes clients to calculate:

- [The HTC and Cloud CPU/h of the VOs of the EGI Federation](pyVOs_CPUs_Accounting)
- [The number of VO users accessing the EGI Infrastructure](pyVOs_Users_Accounting)

  
