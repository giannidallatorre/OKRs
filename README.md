# python-OKRs-statistics
This repository contains python clients to generate statistics about the total CPU/h and the number of users of the EGI Federated Infrastructure. 
Specifically, the statistics generated by these clients are:
- **Cloud CPU/h** consumed by the production VOs of EGI
- **HTC CPU/h** consumed by the production VOs of EGI
- Num. of **'active'**, **'total'** and **'actual' users** registered in the EGI Operations Portal. 

These statistics will be used by EGI to measure progress following the **Objectives and Key Results (OKRs)** goal-setting framework.

The statistics generated by these clients will be pushed in this Google <a href="https://docs.google.com/spreadsheets/d/1B1Sqf1UiN9pY_fGbWe5G1zKA2UzsekOVbLCtiiMFAXk/edit#">Worksheet</a> using the <a href="https://docs.gspread.org/en/v5.10.0/">gspread</a> APIs.

## Pre-requisites
* `Python 3.10.12+` installed on your local computer
* Install pip3: `apt-get install -y python3-pip`
* Install <a href="https://docs.gspread.org/en/v5.10.0/">gspread</a> APIs: `sudo pip3 install gspread`
* Install venv: `sudo apt install -y python3-venv`

## Creating a Google Service Account
In order to read from and write data to Google Sheets in Python, we will have to create a **Google Service Account**.

_"A service account is a special kind of account used by an application or a virtual machine (VM) instance, not a person. 
Applications use service accounts to make authorized API calls, authorized as either the service account itself or as Google Workspace 
or Cloud Identity users through domain-wide delegation"._

**Instructions** to create a service account are the following:
* Head over to <a href="https://console.developers.google.com/">Google developer console</a> and click on “**Create Project**”.
* Fill in the required fields and click on “**Create**”. You will be redirected to the project home page once the project is created.
* Click on “**Enable API and Services**”.
* Search for Google Drive API and click on “**Enable**”. Do the same for the Google Sheets API.
* Click on “**Create Credentials**”
* Select “**Google Drive API**” as the API and “Web server” (e.g. Node.js, Tomcat, etc.) as where you will be calling the API from. Follow the image below to fill in the other options.
* Name the service account, then grant it a “**Project**” role with “**Editor**” access and click on “**Continue**”.
* The credentials will be created and downloaded as a JSON file. If everything is successful, you will see a screen similar to the image below.
* Copy the JSON file to your code directory and rename it to `credentials.json`

## Configuring the environment

Use virtualenv to configure the working environment:

```
]$ virtualenv -p /usr/bin/python3.10 venv
created virtual environment CPython3.10.12.final.0-64 in 1748ms
  creator CPython3Posix(dest=/home/larocca/EGI-modules/APIs/OKR/2.0/venv, clear=False, no_vcs_ignore=False, global=False)
  seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/larocca/.local/share/virtualenv)
    added seed packages: pip==22.0.2, setuptools==59.6.0, wheel==0.37.1
  activators BashActivator,CShellActivator,FishActivator,NushellActivator,PowerShellActivator,PythonActivator

]$ source venv/bin/activate
```

Install the libraries `gspread` with pip3:

```
]$ pip3 install gspread
[..]
```

## Configure the settings

Edit and export the settings:

```
]$ cat openrc.sh 
#!/bin/bash

###################################################
# E G I ** A C C O U N T I N G ** S E T T I N G S #
###################################################
export ACCOUNTING_SERVER_URL="https://accounting.egi.eu"

# Available scope: 'cloud', 'egi'
#export ACCOUNTING_SCOPE="cloud" # for Cloud Compute
export ACCOUNTING_SCOPE="egi"  # for High-Throughput Compute

# Available metrics (for scope=cloud): 
# 'sum_elap_processors', 'mem-GByte', 'vm_num', 'sum_elap', 'cost', 'net_in', 'net_out', 'disk', 'processors'
#export ACCOUNTING_METRIC="sum_elap_processors"

# Available metrics (for scope=grid):
# 'elap_processors', 'njobs', 'normcpu', 'sumcpu', 'normelap', 'normelap_processors', 'sumelap', 'cpueff'
export ACCOUNTING_METRIC="elap_processors"

# Available Local Job Selector: 'onlyinfrajobs', 'localinfrajobs', 'onlylocaljobs'
export ACCOUNTING_LOCAL_JOB_SELECTOR="onlyinfrajobs"

# Available vo_group_selector: 'egi'
export ACCOUNTING_VO_GROUP_SELECTOR="egi"

# Available Data Selector: 'JSON', 'CSV'
export ACCOUNTING_DATA_SELECTOR="JSON"

export DATE_FROM="2023/01"
export DATE_TO="2023/06"

##################################################################
# E G I ** O P E R A T I O N S ** P O R T A L ** S E T T I N G S #
##################################################################
export OPERATIONS_SERVER_URL="https://operations-portal.egi.eu/api/"
export OPERATIONS_API_KEY="*************" 
export OPERATIONS_FORMAT="json"
export OPERATIONS_VO_LIST_PREFIX="vo-list"
export OPERATIONS_VO_ID_CARD_PREFIX="vo-idcard"
export OPERATIONS_VOS_REPORT_PREFIX="egi-reports"

###########################################################
# G O O G L E ** S P R E A D S H E E T ** S E T T I N G S #
###########################################################
export SERVICE_ACCOUNT_PATH=${PWD}"/.config/"
export SERVICE_ACCOUNT_FILE=${SERVICE_ACCOUNT_PATH}"service_account.json"
export GOOGLE_SHEET_NAME="OKR_Reports"
export GOOGLE_CLOUD_WORKSHEET="Accounting Cloud CPU/h"
export GOOGLE_HTC_WORKSHEET="Accounting HTC CPU/h"
export GOOGLE_VOS_WORKSHEET="VOs statistics"

# LOG=INFO, no verbose logging is 'OFF'
# LOG=DEBUG, verbose logging is 'ON'
export LOG="DEBUG"

# SSL_CHECK=False, SSL check is disabled
export SSL_CHECK="True"
```

## Install the credenatials of the Google Service Account

```
]$ mkdir $PWD/.config
]$ cat .config/service_account.json 
{
  "type": "service_account",
  "project_id": "striped-rhino-395008",
  "private_key_id": "****************************",
  "private_key": "-----BEGIN PRIVATE KEY-----
  -----END PRIVATE KEY-----\n",
  "client_email": "python-google-sheet-service-ac@striped-rhino-395008.iam.gserviceaccount.com",
  "client_id": "***************",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/python-google-sheet-service-ac%40striped-rhino-395008.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com"
}
```

